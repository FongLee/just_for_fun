<!DOCTYPE html>
<html>

<head>
    <title>能够检测对象变更</title>
    <script type="text/javascript" src="20180430-拷贝.js"></script>
    <script type="text/javascript" src="20180430-equal函数.js"></script>
</head>

<body>
    <script type="text/javascript">
    function Scope() {
        this.$$watchers = [];

    }

    Scope.prototype.$watch = function(watchfn, listenfn) {
        var watch = {
            watchfn: watchfn,
            listenfn: listenfn
        };
        this.$$watchers.push(watch);
    }

    Scope.prototype.$digest = function() {
        var dirty = false;
        var ttl = 10;
        do {
            dirty = this.$digestOne();
            if (dirty && !(ttl--)) {
                console.log('error');
            }
        } while (dirty);
    }

    Scope.prototype.$digestOne = function() {
        debugger;
        var dirty = false;
        var that = this;
        this.$$watchers.forEach(function(val, index, array) {
            var newVal = val.watchfn(that);
            var oldVal = val.last;
            if (!eq(newVal, oldVal)) {
                val.listenfn(newVal, oldVal, that);
                dirty = true;
            }
            val.last = deepCopy(newVal);
        });

        return dirty;

    };

    window.onload = function() {
        var scope = new Scope();
        scope.name = 'lifeng';
        scope.count = 0;

        scope.$watch(function(scope) {
            return scope.count;
        }, function(newVal, oldVal, scope) {
            this.countTwo = this.count === 2;
            console.log('count is ' + newVal);
        });

        scope.$watch(function(scope) {
                return scope.name;
            },
            function(newVal, oldVal, scope) {
                scope.count++;

                console.log('name is ' + scope.name);
            });

        scope.$digest();
        scope.name = 'hello';
        scope.$digest();

    }
    </script>
</body>

</html>